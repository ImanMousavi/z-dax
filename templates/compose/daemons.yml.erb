version: '3.8'

x-daemon: &peatio-daemon
  image: "<%= @config['image']['peatio'] %>"
  env_file:
    - ../config/peatio.env
  volumes:
    - ../config/peatio/seed:/home/app/config/seed

x-finex-engine: &finex-engine
  image: "<%= @config['finex']['image'] %>"
  env_file:
    - ../config/finex.env

services:
<% if @config['daemons']['withdraw_audit'] -%>
  withdraw_audit:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/daemons.rb withdraw_audit"
<% end -%>

<% if @config['daemons']['blockchain'] -%>
  blockchain:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/daemons.rb blockchain"
<% end -%>

<% if @config['daemons']['cron_job'] -%>
  cron_job:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/daemons.rb cron_job"
<% end -%>

<% if @config['daemons']['upstream'] -%>
  upstream:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/daemons.rb upstream"
<% end -%>

<% if @config['daemons']['deposit_collection'] -%>
  deposit_collection:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/amqp_daemon.rb deposit_collection"
<% end -%>

<% if @config['daemons']['deposit_collection_fees'] -%>
  deposit_collection_fees:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/amqp_daemon.rb deposit_collection_fees"
<% end -%>

<% if @config['daemons']['deposit_coin_address'] -%>
  deposit_coin_address:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/amqp_daemon.rb deposit_coin_address"
<% end -%>

<% ['matching', 'order_processor', 'trade_executor'].each do |engine| %>
<% if @config['daemons'][engine] -%>
<% if @config['finex']['enabled'] %>
  <%= engine %>:
    << : *finex-engine
    command: "/home/app/finex-engine <%= engine %>"
<% else %>
  <%= engine %>:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/amqp_daemon.rb <%= engine %>"
<% end %>
<% end %>
<% end %>

<% if @config['daemons']['withdraw_coin'] -%>
  withdraw_coin:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/amqp_daemon.rb withdraw_coin"
<% end -%>

<% if @config['daemons']['influx_writer'] -%>
  influx_writer:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/amqp_daemon.rb influx_writer"
<% end -%>
