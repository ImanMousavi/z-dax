version: '3.8'

x-daemon: &peatio-daemon
  image: "<%= @config['images']['peatio'] %>"
  restart: always
  env_file:
    - ../config/peatio.env
  volumes:
    - ../config/peatio/seed:/home/app/config/seed

x-finex-daemon: &finex-daemon
  image: "<%= @utils['images']['finex'] %>"
  restart: always
  env_file:
    - ../config/finex.env
  volumes:
    - ../config/finex/config.yaml:/app/config/config.yaml

services:
<% if @config['daemons']['blockchain'] -%>
  blockchain:
    << : *peatio-daemon
    environment:
      - VAULT_TOKEN=<%= @config['vault']['peatio_crypto_token'] %>
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/daemons.rb blockchain"
<% end -%>

<% if @config['daemons']['cron_jobs'] -%>
  cron_jobs:
    << : *peatio-daemon
    environment:
      - VAULT_TOKEN=<%= @config['vault']['peatio_crypto_token'] %>
    command: "./cron_jobs"
<% end -%>

<% if @config['daemons']['finex_cron_job'] -%>
  finex_cron_job:
    << : *finex-daemon
    command: "./finex-daemon cron_job"
<% end -%>

<% if @config['daemons']['deposit'] -%>
  deposit:
    << : *peatio-daemon
    environment:
      - VAULT_TOKEN=<%= @config['vault']['peatio_crypto_token'] %>
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/daemons.rb deposit"
<% end -%>

<% if @config['daemons']['upstream'] -%>
  upstream:
    << : *peatio-daemon
    environment:
      - VAULT_TOKEN=<%= @config['vault']['peatio_upstream_token'] %>
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/daemons.rb upstream"
<% end -%>

<% if @config['daemons']['deposit_coin_address'] -%>
  deposit_coin_address:
    << : *peatio-daemon
    environment:
      - VAULT_TOKEN=<%= @config['vault']['peatio_crypto_token'] %>
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/stream_daemon.rb deposit_coin_address"
<% end -%>

<% if @config['daemons']['market_ticker'] -%>
  market_ticker:
    << : *peatio-daemon
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/stream_daemon.rb market_ticker"
<% end -%>

<% if @config['daemons']['trade_executor'] -%>
  trade_executor:
    << : *peatio-daemon
    command: "./trade_executor -p 9000"
<% end %>

<% if @config['daemons']['matching'] -%>
  matching:
    << : *peatio-daemon
    depends_on:
      - trade_executor
    command: "./matching -p 9000"
<% end %>

<% if @config['daemons']['order_processor'] -%>
  order_processor:
    << : *peatio-daemon
    depends_on:
      - matching
    command: "./order_processor -p 9000"
<% end %>

<% if @config['daemons']['ieo_order_processor'] -%>
  ieo_order_processor:
    << : *finex-daemon
    depends_on:
      - ieo_order_executor
    command: "./finex-engine ieo_order_processor"
<% end %>

<% if @config['daemons']['ieo_order_executor'] -%>
  ieo_order_executor:
    << : *finex-daemon
    command: "./finex-engine ieo_order_executor"
<% end %>

<% if @config['daemons']['withdraw_coin'] -%>
  withdraw_coin:
    << : *peatio-daemon
    environment:
      - VAULT_TOKEN=<%= @config['vault']['peatio_crypto_token'] %>
    command: bash -c "bin/link_config && bundle exec ruby lib/daemons/stream_daemon.rb withdraw_coin"
<% end -%>

  mailer:
    restart: always
    image: mailer
    env_file:
      - ../config/mailer.env
    volumes:
      -  ../config/mailer.yml:/app/config/mailer.yml
