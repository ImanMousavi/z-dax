version: '3.6'

services:
  peatio:
    image: "<%= @config['image']['peatio'] %>"
    networks:
      - autoscale-net
      - backend-net
      - gateway-net
    env_file:
      - ../config/peatio.env
    volumes:
      - peatio_seed:/home/app/config/seed
    command: bash -c "bin/link_config && bundle exec puma --config config/puma.rb"

  barong:
    image: "<%= @config['image']['barong'] %>"
    networks:
      - autoscale-net
      - backend-net
      - gateway-net
    env_file:
      - ../config/barong.env
    secrets:
      - barong.key
    volumes:
      - barong_seed:/home/app/config/seed

  ranger:
    image: "<%= @config['image']['peatio'] %>"
    networks:
      - autoscale-net
      - backend-net
      - gateway-net
    env_file:
      - ../config/ranger.env
    command: bash -c "bundle exec peatio service start ranger"

  postmaster:
    image: "<%= @config['image']['postmaster'] %>"
    networks:
      - autoscale-net
      - backend-net
    env_file:
      - ../config/postmaster.env
    configs:
      - source: postmaster_config
        target: /app/config/postmaster.yml

  frontend:
    image: pagespeed/nginx-pagespeed
    networks:
      - autoscale-net
      - proxy-net
    configs:
      - source: nginx_config
        target: /etc/nginx/nginx.conf
    volumes:
      - frontend_data:/var/www/html
    deploy:
      labels:
        traefik.enable: 'true'
        traefik.frontend.rule: "PathPrefix:/;Host:<%= @config['app']['subdomain'] %>.<%= @config['app']['domain'] %>"
        traefik.docker.network: proxy-net
        traefik.port: 80

volumes:
  peatio_seed:
    driver: "local"
    driver_opts:
      type: "nfs4"
      o: "addr=<%= @config['app']['manager_ip'] %>,ro"
      device: ":/config/peatio/seed"

  barong_seed:
    driver: "local"
    driver_opts:
      type: "nfs4"
      o: "addr=<%= @config['app']['manager_ip'] %>,ro"
      device: ":/config/barong/seed"

  frontend_data:
    driver: "local"
    driver_opts:
      type: "nfs4"
      o: "addr=<%= @config['app']['manager_ip'] %>,nolock,soft,ro"
      device: ":/data/frontend"

configs:
  postmaster_config:
    file: ../config/postmaster/postmaster.yml
  nginx_config:
    file: ../config/nginx/config.conf

secrets:
  barong.key:
    file: ../config/secrets/barong.key

networks:
  autoscale-net:
    external: true
  backend-net:
    external: true
  gateway-net:
    external: true
  proxy-net:
    external: true