version: '3.7'

services:
  envoy:
    image: envoyproxy/envoy:v1.10.0
    networks:
      - gateway-net
      - proxy-net
    configs:
      - source: gateway_config
        target: /etc/envoy/envoy.yaml
    command: /usr/local/bin/envoy -l info -c /etc/envoy/envoy.yaml
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      labels:
        - "traefik.http.routers.gateway-<%= @name %>.rule=Host(`<%= @config['app']['subdomain'] %>.<%= @config['app']['domain'] %>`) && PathPrefix(`/api`,`/admin`,`/admin-assets/`)"
        - "traefik.http.services.gateway-<%= @name %>.loadbalancer.server.port=8099"
        - "traefik.enable=true"
        <%- if @config['ssl']['enabled'] -%>
        - "traefik.http.routers.gateway-<%= @name %>.entrypoints=websecure"
        - "traefik.http.routers.gateway-<%= @name %>.tls=true"
        <%- else -%>
        - "traefik.http.routers.gateway-<%= @name %>.entrypoints=web"
        <%- end -%>

configs:
  gateway_config:
    file: ../config/gateway/envoy.yaml

networks:
  gateway-net:
    driver: overlay
    attachable: true
    name: gateway-net
  proxy-net:
    external: true